{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-zinc-950 pt-20">
    <div class="max-w-7xl mx-auto px-6 py-12">

        <!-- Progress Bar (Zeigarnik Effect) -->
        <div class="max-w-2xl mx-auto mb-8">
            <div class="flex items-center justify-between text-sm text-zinc-500 mb-2">
                <span id="progress-text">Step 1 of 3</span>
                <span id="progress-percent">33% Complete</span>
            </div>
            <div class="w-full bg-zinc-800 rounded-full h-2">
                <div id="progress-bar" class="bg-accent h-2 rounded-full transition-all duration-500"
                    style="width: 33%"></div>
            </div>
            <p id="incomplete-warning" class="text-red-400 text-xs mt-2 hidden">⚠️ Your vault is incomplete. Finish
                securing it now.</p>
        </div>

        <!-- Step 1: Commitment + Seed Entry -->
        <div id="step-seed" class="max-w-2xl mx-auto">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">Secure Your Crypto Inheritance</h1>
                <p class="text-zinc-400">You already know this is a problem. Let's fix it.</p>
            </div>

            <div class="border-gradient rounded-xl p-8 bg-zinc-900/50">
                <!-- Commitment & Consistency -->
                <div class="mb-8 space-y-4">
                    <p class="text-white font-semibold mb-4">Before we start, confirm:</p>
                    <label class="flex items-start gap-3 cursor-pointer group">
                        <input type="checkbox" id="commit-1" onchange="checkCommitments()"
                            class="mt-1 w-5 h-5 rounded border-zinc-700 bg-zinc-900 text-accent focus:ring-accent">
                        <span class="text-zinc-400 group-hover:text-white transition">I want to protect my crypto from
                            loss or theft</span>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer group">
                        <input type="checkbox" id="commit-2" onchange="checkCommitments()"
                            class="mt-1 w-5 h-5 rounded border-zinc-700 bg-zinc-900 text-accent focus:ring-accent">
                        <span class="text-zinc-400 group-hover:text-white transition">I want my family to inherit my
                            assets if something happens to me</span>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer group">
                        <input type="checkbox" id="commit-3" onchange="checkCommitments()"
                            class="mt-1 w-5 h-5 rounded border-zinc-700 bg-zinc-900 text-accent focus:ring-accent">
                        <span class="text-zinc-400 group-hover:text-white transition">I'm ready to secure my seed phrase
                            properly (not just a piece of paper)</span>
                    </label>
                </div>

                <div class="border-t border-zinc-800 pt-6">
                    <label class="block text-sm font-medium text-zinc-400 mb-2">Your 12 or 24 Word Seed Phrase</label>
                    <textarea id="seed-input" rows="4"
                        placeholder="witch collapse practice feed shame open despair creek road again ice least..."
                        class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-3 text-white font-mono text-sm focus:border-accent outline-none"></textarea>
                    <p class="text-xs text-zinc-500 mt-2">✓ Never leaves your device · ✓ Client-side encryption only</p>
                </div>

                <button onclick="proceedToPayment()" id="continue-btn" disabled
                    class="w-full mt-6 py-4 bg-zinc-800 text-zinc-600 font-bold rounded-lg cursor-not-allowed transition">
                    Check all boxes to continue
                </button>
            </div>
        </div>

        <!-- Step 2: Payment -->
        <div id="step-payment" class="hidden">
            <div class="grid lg:grid-cols-2 gap-8 items-start">

                <!-- LEFT: Stripe Checkout -->
                <div class="lg:sticky lg:top-24">
                    <div class="border-gradient rounded-xl p-8 bg-zinc-900/50">
                        <h2 class="text-2xl font-bold text-white mb-2">Complete Payment</h2>
                        <p class="text-zinc-400 mb-6">Your seed is ready to split. Secure it now.</p>

                        <div id="checkout"></div>

                        <div class="mt-6 pt-6 border-t border-zinc-800">
                            <div class="flex items-center gap-2 text-sm text-zinc-500">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span>Secured by Stripe</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Seed Preview + Loss Aversion -->
                <div class="space-y-6">
                    <div class="border-gradient rounded-xl p-8 bg-zinc-900/50">
                        <h3 class="text-xl font-bold text-white mb-4">✓ Your Seed is Ready</h3>
                        <div class="bg-black/50 border border-zinc-800 rounded-lg p-4 mb-4">
                            <p class="text-zinc-500 text-xs mb-2">ENCRYPTED SEED PREVIEW</p>
                            <p id="seed-preview" class="text-white font-mono text-sm break-all"></p>
                        </div>
                        <p class="text-zinc-400 text-sm">
                            Complete payment to split this into 3 shards and activate your dead man's switch.
                        </p>
                    </div>

                    <!-- Hyperbolic Discounting + Loss Aversion -->
                    <div class="p-6 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <p class="text-red-400 text-sm font-semibold mb-2">⚠️ Don't Leave Now</p>
                        <p class="text-red-300 text-sm">
                            <strong>Lose your seed TODAY = Lose everything FOREVER.</strong><br>
                            Secure it NOW = Peace of mind FOREVER.
                        </p>
                        <p class="text-red-400/70 text-xs mt-3">
                            Abandoning now = starting over. You already invested time entering your seed.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    let userSeed = '';

    // Check if all commitments are checked
    function checkCommitments() {
        const c1 = document.getElementById('commit-1').checked;
        const c2 = document.getElementById('commit-2').checked;
        const c3 = document.getElementById('commit-3').checked;
        const btn = document.getElementById('continue-btn');

        if (c1 && c2 && c3) {
            btn.disabled = false;
            btn.classList.remove('bg-zinc-800', 'text-zinc-600', 'cursor-not-allowed');
            btn.classList.add('bg-accent', 'text-black', 'hover:bg-emerald-400');
            btn.textContent = 'Continue to Payment →';
        } else {
            btn.disabled = true;
            btn.classList.add('bg-zinc-800', 'text-zinc-600', 'cursor-not-allowed');
            btn.classList.remove('bg-accent', 'text-black', 'hover:bg-emerald-400');
            btn.textContent = 'Check all boxes to continue';
        }
    }

    function proceedToPayment() {
        const seedInput = document.getElementById('seed-input');
        userSeed = seedInput.value.trim();

        if (!userSeed) {
            alert('Please enter your seed phrase first');
            return;
        }

        // Validate seed (12 or 24 words)
        const words = userSeed.split(/\s+/);
        if (words.length !== 12 && words.length !== 24) {
            alert('Seed phrase must be 12 or 24 words');
            return;
        }

        // Store in sessionStorage
        sessionStorage.setItem('shardium_seed', userSeed);

        // Show preview
        const preview = words.slice(0, 3).join(' ') + ' ... ' + words.slice(-3).join(' ');
        document.getElementById('seed-preview').textContent = preview;

        // Update progress (Zeigarnik Effect)
        document.getElementById('progress-text').textContent = 'Step 2 of 3';
        document.getElementById('progress-percent').textContent = '66% Complete';
        document.getElementById('progress-bar').style.width = '66%';
        document.getElementById('incomplete-warning').classList.remove('hidden');

        // Hide step 1, show step 2
        document.getElementById('step-seed').classList.add('hidden');
        document.getElementById('step-payment').classList.remove('hidden');

        // Initialize Stripe checkout
        const stripe = Stripe('{{ stripe_pk }}');
        stripe.initEmbeddedCheckout({
            clientSecret: '{{ client_secret }}',
        }).then(checkout => {
            checkout.mount('#checkout');
        });
    }
</script>
{% endblock %}