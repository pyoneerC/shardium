{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-zinc-950 pt-20">
    <div class="max-w-7xl mx-auto px-6 py-12">

        <!-- Step 1: Seed Phrase Entry (IKEA Effect) -->
        <div id="step-seed" class="max-w-2xl mx-auto">
            <div class="text-center mb-8">
                <div class="inline-block px-4 py-2 bg-accent/10 border border-accent/30 rounded-lg mb-4">
                    <span class="text-accent font-semibold">Step 1 of 3</span>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">Enter Your Seed Phrase</h1>
                <p class="text-zinc-400">We'll split it into 3 shards. Client-side encryption only.</p>
            </div>

            <div class="border-gradient rounded-xl p-8 bg-zinc-900/50">
                <label class="block text-sm font-medium text-zinc-400 mb-2">Your 12 or 24 Word Seed Phrase</label>
                <textarea id="seed-input" rows="4"
                    placeholder="witch collapse practice feed shame open despair creek road again ice least..."
                    class="w-full bg-black/50 border border-zinc-700 rounded-lg px-4 py-3 text-white font-mono text-sm focus:border-accent outline-none"></textarea>
                <p class="text-xs text-zinc-500 mt-2">✓ Never leaves your device · ✓ Client-side encryption only</p>

                <button onclick="proceedToPayment()"
                    class="w-full mt-6 py-4 bg-accent text-black font-bold rounded-lg hover:bg-emerald-400 transition">
                    Continue to Payment →
                </button>
            </div>
        </div>

        <!-- Step 2: Payment (After Seed Entry) -->
        <div id="step-payment" class="hidden">
            <div class="grid lg:grid-cols-2 gap-8 items-start">

                <!-- LEFT: Stripe Checkout -->
                <div class="lg:sticky lg:top-24">
                    <div class="border-gradient rounded-xl p-8 bg-zinc-900/50">
                        <div class="text-center mb-4">
                            <div class="inline-block px-4 py-2 bg-accent/10 border border-accent/30 rounded-lg mb-4">
                                <span class="text-accent font-semibold">Step 2 of 3</span>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Complete Payment</h2>
                        <p class="text-zinc-400 mb-6">Your seed is ready to split. Secure it now.</p>

                        <!-- Stripe Embedded Checkout -->
                        <div id="checkout"></div>

                        <div class="mt-6 pt-6 border-t border-zinc-800">
                            <div class="flex items-center gap-2 text-sm text-zinc-500">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                        clip-rule="evenodd" />
                                </svg>
                                <span>Secured by Stripe</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Seed Preview (Shows they already invested) -->
                <div class="border-gradient rounded-xl p-8 bg-zinc-900/50">
                    <h3 class="text-xl font-bold text-white mb-4">✓ Your Seed is Ready</h3>
                    <div class="bg-black/50 border border-zinc-800 rounded-lg p-4 mb-4">
                        <p class="text-zinc-500 text-xs mb-2">ENCRYPTED SEED PREVIEW</p>
                        <p id="seed-preview" class="text-white font-mono text-sm break-all"></p>
                    </div>
                    <p class="text-zinc-400 text-sm">
                        Complete payment to split this into 3 shards and activate your dead man's switch.
                    </p>

                    <div class="mt-6 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                        <p class="text-red-400 text-sm">
                            ⚠️ <strong>Don't leave now.</strong> Your seed is entered but not secured.
                            Abandoning = starting over.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    let userSeed = '';

    function proceedToPayment() {
        const seedInput = document.getElementById('seed-input');
        userSeed = seedInput.value.trim();

        if (!userSeed) {
            alert('Please enter your seed phrase first');
            return;
        }

        // Validate seed (12 or 24 words)
        const words = userSeed.split(/\s+/);
        if (words.length !== 12 && words.length !== 24) {
            alert('Seed phrase must be 12 or 24 words');
            return;
        }

        // Store in sessionStorage (survives page refresh during payment)
        sessionStorage.setItem('shardium_seed', userSeed);

        // Show preview (first 3 words + ... + last 3 words)
        const preview = words.slice(0, 3).join(' ') + ' ... ' + words.slice(-3).join(' ');
        document.getElementById('seed-preview').textContent = preview;

        // Hide step 1, show step 2
        document.getElementById('step-seed').classList.add('hidden');
        document.getElementById('step-payment').classList.remove('hidden');

        // Initialize Stripe checkout
        const stripe = Stripe('{{ stripe_pk }}');
        stripe.initEmbeddedCheckout({
            clientSecret: '{{ client_secret }}',
        }).then(checkout => {
            checkout.mount('#checkout');
        });
    }
</script>
{% endblock %}